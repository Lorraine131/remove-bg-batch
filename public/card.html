<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AI贺卡制作</title>
    <script src="https://unpkg.com/konva@8.3.2/konva.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #container {
            display: flex;
        }
        #toolbar {
            width: 250px;
            padding: 10px;
            border-right: 1px solid #ccc;
        }
        #canvas-container {
            margin-left: 20px;
            border: 1px solid #eee;
            padding: 10px;
        }
        button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .bg-option {
            width: 100%;
            height: 80px;
            margin: 5px 0;
            cursor: pointer;
            border: 2px solid #ddd;
            object-fit: cover;
            transition: all 0.3s;
        }
        .bg-option:hover {
            border-color: #4CAF50;
            transform: scale(1.02);
        }
        .bg-option.selected {
            border-color: #2196F3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
        }
        #custom-bg {
            display: none;
        }
    </style>
</head>
<body>
    <h1>AI贺卡编辑器</h1>
    <div id="container">
        <div id="toolbar">
            <h3>背景选择</h3>
            <div id="bg-options">
                <img src="/backgrounds/bg1.jpg" class="bg-option" onclick="changeBg(this)">
                <img src="/backgrounds/bg2.jpg" class="bg-option" onclick="changeBg(this)">
                <img src="/backgrounds/bg3.jpg" class="bg-option" onclick="changeBg(this)">
            </div>
            
            <input type="file" id="custom-bg" accept="image/*">
            <button onclick="document.getElementById('custom-bg').click()">上传自定义背景</button>
            
            <h3>文字工具</h3>
            <input type="text" id="text-input" placeholder="输入祝福语">
            <button onclick="addText()">添加文字</button>
            
            <h3>操作</h3>
            <button onclick="download()">下载贺卡</button>
        </div>
        
        <div id="canvas-container">
            <div id="canvas"></div>
        </div>
    </div>

    <script>
        // 初始化画布
        const stage = new Konva.Stage({
            container: 'canvas',
            width: 800,
            height: 600
        });
        const layer = new Konva.Layer();
        stage.add(layer);
        
        // 当前背景图
        let currentBg = null;
        
        // 从抠图页面加载图片
        function loadImages() {
            const images = JSON.parse(sessionStorage.getItem("cardImages")) || [];
            
            images.forEach((url, i) => {
                Konva.Image.fromURL(url, function(img) {
                    img.setAttrs({
                        x: 100 + (i % 3) * 210,
                        y: 100 + Math.floor(i / 3) * 210,
                        width: 200,
                        height: 200,
                        draggable: true,
                        shadowColor: 'black',
                        shadowBlur: 10,
                        shadowOpacity: 0.5,
                        shadowOffset: { x: 5, y: 5 }
                    });
                    layer.add(img);
                    layer.draw();
                });
            });
            
            // 默认加载第一个背景
            if (document.querySelector('.bg-option')) {
                changeBg(document.querySelector('.bg-option'));
            }
        }
        
        // 更换背景
        function changeBg(element) {
            // 移除之前选中的样式
            document.querySelectorAll('.bg-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // 添加选中样式
            element.classList.add('selected');
            
            Konva.Image.fromURL(element.src, function(bgImg) {
                // 移除旧背景
                if (currentBg) {
                    currentBg.destroy();
                }
                
                bgImg.setAttrs({
                    width: stage.width(),
                    height: stage.height(),
                    listening: false // 背景不可交互
                });
                
                layer.add(bgImg);
                layer.draw();
                currentBg = bgImg;
                
                // 将背景置于最底层
                bgImg.moveToBottom();
            });
        }
        
        // 自定义背景上传
        document.getElementById('custom-bg').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const tempImg = new Image();
                tempImg.src = event.target.result;
                tempImg.onload = function() {
                    // 创建临时选项
                    const option = document.createElement('img');
                    option.className = 'bg-option selected';
                    option.src = event.target.result;
                    option.onclick = function() { changeBg(this); };
                    
                    // 清除其他选中状态
                    document.querySelectorAll('.bg-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // 添加到选项列表最前面
                    document.getElementById('bg-options').prepend(option);
                    changeBg(option);
                };
            };
            reader.readAsDataURL(file);
        });
        
        // 添加文字
        function addText() {
            const text = new Konva.Text({
                text: document.getElementById('text-input').value,
                x: 50,
                y: 50,
                fontSize: 30,
                fontFamily: 'Arial',
                fill: '#333333',
                draggable: true,
                shadowColor: 'rgba(0,0,0,0.5)',
                shadowBlur: 5,
                shadowOffset: { x: 2, y: 2 },
                shadowOpacity: 0.8
            });
            layer.add(text);
            layer.draw();
            document.getElementById('text-input').value = '';
        }
        
        // 下载贺卡
        function download() {
            const dataURL = stage.toDataURL({ 
                mimeType: 'image/png',
                quality: 0.9
            });
            const link = document.createElement('a');
            link.download = 'custom-card.png';
            link.href = dataURL;
            link.click();
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            loadImages();
        };
    </script>
</body>
</html>
