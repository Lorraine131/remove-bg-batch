<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>贺卡编辑器</title>
    <script src="https://unpkg.com/konva@8.3.2/konva.min.js"></script>
    <style>
        /* 原有样式保留，新增以下样式 */
        #image-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin: 5px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        .thumbnail:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }
        .thumbnail.selected {
            border-color: #2196F3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
        }
        #canvas-container {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>贺卡编辑器</h1>
    <div style="display: flex;">
        <!-- 左侧控制面板 -->
        <div style="width: 250px; padding: 10px;">
            <h3>可选图片</h3>
            <div id="image-selector">
                <!-- 图片缩略图将在这里动态生成 -->
            </div>
            
            <h3>背景选择</h3>
            <select id="bg-select">
                <option value="#ffffff">纯白背景</option>
                <option value="#f5f5f5">浅灰背景</option>
                <option value="url(/backgrounds/bg1.jpg)">背景1</option>
                <option value="url(/backgrounds/bg2.jpg)">背景2</option>
            </select>
            
            <h3>文字工具</h3>
            <input type="text" id="text-input" placeholder="输入祝福语">
            <button onclick="addText()">添加文字</button>
            <div>
                <label>文字颜色: <input type="color" id="text-color" value="#000000"></label>
                <label>大小: <input type="range" id="text-size" min="12" max="72" value="24"></label>
            </div>
            
            <button onclick="downloadCard()" style="margin-top: 20px; background: #4CAF50;">下载贺卡</button>
        </div>
        
        <!-- 右侧画布区域 -->
        <div id="canvas-container" style="border: 1px solid #ccc; margin-left: 20px;">
            <div id="canvas"></div>
        </div>
    </div>

    <script>
        // 初始化舞台
        const stage = new Konva.Stage({
            container: 'canvas',
            width: 800,
            height: 600
        });
        const layer = new Konva.Layer();
        stage.add(layer);
        
        // 存储所有添加的图片元素
        const addedImages = [];
        let currentBg = null;
        
        // 加载从抠图页面传来的图片
        function loadImages() {
            const imageData = JSON.parse(sessionStorage.getItem("cardImages")) || [];
            const container = document.getElementById("image-selector");
            
            if (imageData.length === 0) {
                container.innerHTML = "<p>没有可用的图片，请先返回抠图页面</p>";
                return;
            }
            
            // 生成缩略图选择器
            imageData.forEach((img, index) => {
                const thumb = document.createElement("img");
                thumb.src = img.url;
                thumb.className = "thumbnail";
                thumb.title = img.name;
                thumb.onclick = function() {
                    addImageToCanvas(img.url);
                    // 高亮选中状态
                    document.querySelectorAll(".thumbnail").forEach(t => t.classList.remove("selected"));
                    this.classList.add("selected");
                };
                container.appendChild(thumb);
            });
            
            // 设置默认背景
            changeBackground(document.getElementById("bg-select").value);
        }
        
        // 添加图片到画布
        function addImageToCanvas(imageUrl) {
            Konva.Image.fromURL(imageUrl, function(img) {
                img.setAttrs({
                    x: stage.width() / 2 - 100,
                    y: stage.height() / 2 - 100,
                    width: 200,
                    height: 200,
                    draggable: true,
                    shadowColor: 'black',
                    shadowBlur: 10,
                    shadowOpacity: 0.3,
                    shadowOffset: { x: 5, y: 5 }
                });
                
                // 存储引用以便后续操作
                addedImages.push(img);
                layer.add(img);
                layer.draw();
            });
        }
        
        // 更换背景
        function changeBackground(bgValue) {
            // 清除旧背景
            if (currentBg) {
                currentBg.destroy();
            }
            
            if (bgValue.startsWith("url(")) {
                // 图片背景
                Konva.Image.fromURL(bgValue.slice(4, -1), function(bgImg) {
                    bgImg.setAttrs({
                        width: stage.width(),
                        height: stage.height(),
                        listening: false
                    });
                    layer.add(bgImg);
                    bgImg.moveToBottom();
                    currentBg = bgImg;
                    layer.draw();
                });
            } else {
                // 纯色背景
                const bgRect = new Konva.Rect({
                    width: stage.width(),
                    height: stage.height(),
                    fill: bgValue,
                    listening: false
                });
                layer.add(bgRect);
                bgRect.moveToBottom();
                currentBg = bgRect;
                layer.draw();
            }
        }
        
        // 添加文字
        function addText() {
            const text = new Konva.Text({
                text: document.getElementById("text-input").value,
                x: 50,
                y: 50,
                fontSize: parseInt(document.getElementById("text-size").value),
                fontFamily: 'Arial',
                fill: document.getElementById("text-color").value,
                draggable: true,
                shadowColor: 'rgba(0,0,0,0.5)',
                shadowBlur: 5,
                shadowOffset: { x: 2, y: 2 },
                shadowOpacity: 0.8
            });
            layer.add(text);
            layer.draw();
        }
        
        // 下载贺卡
        function downloadCard() {
            const dataURL = stage.toDataURL({ 
                mimeType: 'image/png',
                quality: 0.95
            });
            const link = document.createElement('a');
            link.download = 'custom-card.png';
            link.href = dataURL;
            link.click();
        }
        
        // 初始化事件监听
        document.getElementById("bg-select").addEventListener("change", function() {
            changeBackground(this.value);
        });
        
        // 页面加载完成后初始化
        window.onload = function() {
            loadImages();
        };
    </script>
</body>
</html>
